---
import "../styles/styles.scss";
import MainLayout from "../layouts/main.astro";
---

<MainLayout title="Register">
	<section class="container" style="width: 33%;">
		<article>
			<header><h2>Sign Up</h2></header>
			<form id="register-form">
				<fieldset>
					<label> Username </label>
					<input
						name="username"
						id="username"
						placeholder="Username"
						autocomplete="username"
					/>
					<small>Optional.</small>
					<label for="email">Email</label>
					<input
						type="email"
						id="email"
						name="email"
						placeholder="Email"
						autocomplete="email"
					/>

					<small
						>Just in case you forget your
						password.</small
					>

					<label for="password">Password</label>
					<input
						type="password"
						id="password"
						name="password"
						placeholder="Password"
						autocomplete="new-password"
					/>

					<small
						>In case you lose your admin
						key.</small
					>
				</fieldset>
				<button type="submit">Create Account</button>
				<a
					href="/login"
					id="login-page"
					style="cursor: pointer;"
					>Log In to Existing Account</a
				>
			</form>
			<hr />
			<div role="alert" aria-live="assertive"></div>

			<script>
				import { navigate } from "astro:transitions/client";
				import { ACCOUNT_PAGE_BASE } from "@/lib/client/urls";
				import { setupForm } from "@/lib/client/utils";
				import { authClient } from "@/lib/client/auth-client";
				import { signUpFormSchema } from "@/lib/client/schemas";

				setupForm("#register-form", {
					onBusy: "Creating...",
					schema: signUpFormSchema,
					onSubmit: async (submission: {
						username: string;
						email: string;
						password: string;
					}) => {
						const resp =
							await authClient.signUp.email(
								{
									name: submission.username,
									username: submission.username,
									email: submission.email,
									password: submission.password,
								},
								{
									onSuccess: () => {
										navigate(
											ACCOUNT_PAGE_BASE,
										);
									},
								},
							);

						if (resp.error) {
							return resp.error
								.message as string;
						} else {
						}

						return true;
					},
				});
			</script>
		</article>
	</section>
</MainLayout>
